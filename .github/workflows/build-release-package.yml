name: Build and Release DEB Package

on:
  workflow_dispatch:
    inputs:
      version_major:
        description: 'Major version (e.g., 9.2.0)'
        required: true
        type: string
      build_number:
        description: 'Build number'
        required: true
        type: string

jobs:
  build-and-release:
    name: Build and Release DEB Package
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ruby \
            ruby-dev \
            rubygems \
            rpm \
            debhelper \
            devscripts \
            git

      - name: Install fpm for package building
        run: |
          sudo gem install --no-document fpm

      - name: Install npm dependencies
        run: |
          # Install dependencies for all modules
          npm ci || npm install
          npm --prefix Common ci || npm --prefix Common install
          npm --prefix DocService ci || npm --prefix DocService install
          npm --prefix FileConverter ci || npm --prefix FileConverter install
          npm --prefix Metrics ci || npm --prefix Metrics install
          npm --prefix SpellChecker ci || npm --prefix SpellChecker install
          npm --prefix AdminPanel/server ci || npm --prefix AdminPanel/server install
          npm ci --include=dev --prefix AdminPanel/client || npm install --include=dev --prefix AdminPanel/client

      - name: Build AdminPanel client
        run: |
          npm --prefix AdminPanel/client run build

      - name: Update version information
        env:
          PRODUCT_VERSION: ${{ inputs.version_major }}
          BUILD_NUMBER: ${{ inputs.build_number }}
        run: |
          # Update version in commondefines.js if it exists
          if [ -f "Common/sources/commondefines.js" ]; then
            sed -i "s|\(const buildVersion = \).*|\1'${PRODUCT_VERSION}';|" Common/sources/commondefines.js
            sed -i "s|\(const buildNumber = \).*|\1${BUILD_NUMBER};|" Common/sources/commondefines.js
          fi

          # Update build date in license.js if it exists
          if [ -f "Common/sources/license.js" ]; then
            sed -i "s|\(const buildDate = \).*|\1'$(date +%F)';|" Common/sources/license.js
          fi

          echo "Version: ${PRODUCT_VERSION}-${BUILD_NUMBER}"

      - name: Create .deb package
        env:
          PRODUCT_VERSION: ${{ inputs.version_major }}
          BUILD_NUMBER: ${{ inputs.build_number }}
        run: |
          # Prepare package structure
          PKG_DIR="package"
          SERVER_DIR="${PKG_DIR}/var/www/onlyoffice/documentserver/server"

          mkdir -p ${SERVER_DIR}
          mkdir -p ${PKG_DIR}/etc/onlyoffice/documentserver
          mkdir -p ${PKG_DIR}/var/log/onlyoffice/documentserver
          mkdir -p ${PKG_DIR}/var/lib/onlyoffice/documentserver/App_Data

          # Copy server modules with dependencies
          echo "Copying server modules..."
          for module in Common DocService FileConverter Metrics SpellChecker AdminPanel; do
            if [ -d "$module" ]; then
              echo "  - $module"
              cp -r $module ${SERVER_DIR}/
              # Remove dev dependencies and unnecessary files
              if [ -d "${SERVER_DIR}/${module}/node_modules" ]; then
                find ${SERVER_DIR}/${module}/node_modules -name "*.md" -delete
                find ${SERVER_DIR}/${module}/node_modules -name "test" -type d -exec rm -rf {} + 2>/dev/null || true
                find ${SERVER_DIR}/${module}/node_modules -name "tests" -type d -exec rm -rf {} + 2>/dev/null || true
              fi
            fi
          done

          # Copy schema
          if [ -d "schema" ]; then
            echo "Copying schema..."
            cp -r schema ${SERVER_DIR}/
          fi

          # Copy tools if they exist
          if [ -d "tools" ]; then
            echo "Copying tools..."
            cp -r tools ${SERVER_DIR}/
          fi

          # Copy license files
          echo "Copying license files..."
          cp LICENSE.txt ${SERVER_DIR}/ 2>/dev/null || echo "LICENSE.txt not found"
          cp 3rd-Party.txt ${SERVER_DIR}/ 2>/dev/null || echo "3rd-Party.txt not found"

          # Create post-install script
          cat > ${PKG_DIR}/post-install.sh << 'EOF'
          #!/bin/bash
          set -e

          # Create onlyoffice user if it doesn't exist
          if ! id -u onlyoffice > /dev/null 2>&1; then
            useradd -m -d /var/www/onlyoffice -r -U onlyoffice
          fi

          # Set permissions
          chown -R onlyoffice:onlyoffice /var/www/onlyoffice || true
          chown -R onlyoffice:onlyoffice /var/log/onlyoffice || true
          chown -R onlyoffice:onlyoffice /var/lib/onlyoffice || true

          echo "OnlyOffice DocumentServer installed successfully"
          echo "Configuration files are in /etc/onlyoffice/documentserver"
          echo "Server files are in /var/www/onlyoffice/documentserver/server"
          EOF
          chmod +x ${PKG_DIR}/post-install.sh

          # Create pre-remove script
          cat > ${PKG_DIR}/pre-remove.sh << 'EOF'
          #!/bin/bash
          # Stop services if running
          echo "Stopping OnlyOffice services if running..."
          EOF
          chmod +x ${PKG_DIR}/pre-remove.sh

          # Build the .deb package
          echo "Building .deb package..."
          fpm -s dir -t deb \
            -n onlyoffice-documentserver \
            -v "${PRODUCT_VERSION}-${BUILD_NUMBER}.oou" \
            -a amd64 \
            --description "ONLYOFFICE Document Server - Server Component" \
            --url "https://www.onlyoffice.com/" \
            --license "AGPL-3.0" \
            --vendor "Ascensio System SIA" \
            --maintainer "Ascensio System SIA <support@onlyoffice.com>" \
            --after-install ${PKG_DIR}/post-install.sh \
            --before-remove ${PKG_DIR}/pre-remove.sh \
            --depends "nodejs >= 18.0.0" \
            -C ${PKG_DIR} \
            var

          echo "Package created successfully:"
          ls -lh *.deb

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ inputs.version_major }}.${{ inputs.build_number }}
          release_name: Release ${{ inputs.version_major }}.${{ inputs.build_number }}
          draft: false
          prerelease: false

      - name: Upload DEB package to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./onlyoffice-documentserver_${{ inputs.version_major }}-${{ inputs.build_number }}.oou_amd64.deb
          asset_name: onlyoffice-documentserver_${{ inputs.version_major }}-${{ inputs.build_number }}.oou_amd64.deb
          asset_content_type: application/vnd.debian.binary-package

      - name: Output download URL
        run: |
          echo "Package is available at:"
          echo "https://github.com/${{ github.repository }}/releases/download/${{ inputs.version_major }}.${{ inputs.build_number }}/onlyoffice-documentserver_${{ inputs.version_major }}-${{ inputs.build_number }}.oou_amd64.deb"
